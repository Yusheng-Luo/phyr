<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>phyr_example_empirical • phyr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="phyr_example_empirical">
<meta property="og:description" content="phyr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/benchmarks.html">Performance benchmark</a>
    </li>
    <li>
      <a href="../articles/pglmm.html">Usage of pglmm()</a>
    </li>
    <li>
      <a href="../articles/phyr_example_empirical.html">phyr_example_empirical</a>
    </li>
    <li>
      <a href="../articles/plot-re.html">Plot random terms of communityPGLMM</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daijiang/phyr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>phyr_example_empirical</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/daijiang/phyr/blob/master/vignettes/phyr_example_empirical.Rmd"><code>vignettes/phyr_example_empirical.Rmd</code></a></small>
      <div class="hidden name"><code>phyr_example_empirical.Rmd</code></div>

    </div>

    
    
<div id="communitypglmm-example-on-simple-empirical-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#communitypglmm-example-on-simple-empirical-dataset" class="anchor"></a>communityPGLMM Example on Simple Empirical Dataset</h2>
<p>This vignette will show a complete analysis example for <code>communityPGLMM</code> on a simple empirical dataset. The dataset is taken from Dinnage (2009). Here we will demonstrate how to fit a communityPGLMM, including main phylogenetic effects, nested phylogenetic effects, as well as including environmental covariates. First let’s load the dataset and take a look at what we have. The data is included in <code>phyr</code>, so we can just call <code><a href="https://rdrr.io/r/utils/data.html">data(oldfield)</a></code> to load it.</p>
</div>
<div id="modelling-old-field-plants-as-a-function-of-phylogeny-and-distubance" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling-old-field-plants-as-a-function-of-phylogeny-and-distubance" class="anchor"></a>Modelling Old Field Plants as a Function of Phylogeny and Distubance</h2>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/daijiang/phyr">phyr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ape-package.ird.fr">ape</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org">dplyr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"oldfield"</span>)
</pre></div>
<p>The data is a list with two elements. The first element is a phylogeny containing 47 species of plants (all herbaceous forbs) that live in old field habitats in Southern Ontario, Canada. Oldfield habitats typically are found in areas that were formerly cultivated but are now abandoned. This is often considered a successional stage between farmland and secondary forest. This data comes from plots that had experience two “treatments”, one set of plots had been disturbed by field ploughing within a few years of sampling, the other set had not been disturbed in this way recently. Let’s have a look at the phylogeny and data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">oldfield</span><span class="op">$</span><span class="kw">phy</span>)
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/init_plots-1.png" width="80%"></p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">oldfield</span><span class="op">$</span><span class="kw">data</span>, <span class="fl">40</span>)
<span class="co">#&gt; # A tibble: 40 x 7</span>
<span class="co">#&gt;    site_orig habitat_type sp            abundance disturbance site          pres</span>
<span class="co">#&gt;        &lt;int&gt; &lt;chr&gt;        &lt;chr&gt;             &lt;int&gt;       &lt;dbl&gt; &lt;chr&gt;        &lt;int&gt;</span>
<span class="co">#&gt;  1         1 undisturbed  Daucus_carota         0           0 1_undisturb…     0</span>
<span class="co">#&gt;  2         6 undisturbed  Daucus_carota         0           0 6_undisturb…     0</span>
<span class="co">#&gt;  3         7 undisturbed  Daucus_carota         0           0 7_undisturb…     0</span>
<span class="co">#&gt;  4         9 undisturbed  Daucus_carota         0           0 9_undisturb…     0</span>
<span class="co">#&gt;  5        10 undisturbed  Daucus_carota         0           0 10_undistur…     0</span>
<span class="co">#&gt;  6        11 undisturbed  Daucus_carota         0           0 11_undistur…     0</span>
<span class="co">#&gt;  7        13 undisturbed  Daucus_carota         1           0 13_undistur…     1</span>
<span class="co">#&gt;  8        15 undisturbed  Daucus_carota         0           0 15_undistur…     0</span>
<span class="co">#&gt;  9        16 undisturbed  Daucus_carota         0           0 16_undistur…     0</span>
<span class="co">#&gt; 10        18 undisturbed  Daucus_carota         0           0 18_undistur…     0</span>
<span class="co">#&gt; # … with 30 more rows</span>
</pre></div>
<p>With this data we are interested in asking whether there is any kind of phylogenetic structure in the distribution of these species as well as whether disturbance has any overall effects. To do this we will specify two different phylogenetic effects in our <code>phyr</code>, which uses a syntax similar to the <code>lme4</code> package for specifying random effects. We also include site-level random effects to account for the paired design of the experiment. We will start by modeling just presence and absence of species (a binomial model). Note this model will take awhile when using maximum likelihood (the Bayesian method is much faster). This is the full model specification:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">mod</span> <span class="op">&lt;-</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm.html">pglmm</a></span>(<span class="kw">pres</span> <span class="op">~</span> <span class="kw">disturbance</span> <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span>) <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">site</span>) <span class="op">+</span> 
                     (<span class="kw">disturbance</span> <span class="op">|</span> <span class="kw">sp__</span>) <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span><span class="op">@</span>site), 
                   data = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">data</span>, 
                   cov_ranef = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(sp = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">phy</span>),
                   family = <span class="st">"binomial"</span>)
</pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="kw">mod</span>, <span class="st">"~/Documents/pglmm_mod_vignette.rds"</span>)
</pre></div>
<p>Here we specified an overall phylogenetic effect using <code>sp__</code>, which also automatically includes an i.i.d. effect of species. <code>phyr</code> finds the linked phylogenetic data because we specified the phylogeny in the <code>cov_ranef</code> argument, giving it the name <code>sp</code> which matches <code>sp__</code> but without the underscores. We can include any number of phylogenies or covariance matrices in this way, allowing us to model multiple sources of covariance in one model. In this example, however, we will stick to one phylogeny to cover the basics of how to run <code>phyr</code> models. We use the same phylogeny to model a second phylogenetic random effects in this model, which is specified as <code>sp__@site</code>. This is a “nested” phylogenetic effect. What this basically means is we are fitting an effect that had covariance proportional to the species phylogeny, but independently for each site (or “nested” in sites). We’ve also included a disturbance by phylogenetic species effect (<code>(disturbance | sp__)</code>), which estimates the degree to which occurrance in disturbed vs. undisturbed habitat has a phylogenetic signal. Like the main <code>sp__</code> effect, the disturbance by <code>sp__</code> effects also includes and i.i.d. species by disturbance interaction. Let’s look at the results:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">mod</span>)
<span class="co">#&gt; Generalized linear mixed model for binomial data fit by restricted maximum likelihood</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:pres ~ disturbance</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;                  Variance Std.Dev</span>
<span class="co">#&gt; 1|sp             2.000000 1.41421</span>
<span class="co">#&gt; 1|sp__           0.060000 0.24495</span>
<span class="co">#&gt; 1|site           0.000240 0.01549</span>
<span class="co">#&gt; disturbance|sp   1.780000 1.33417</span>
<span class="co">#&gt; disturbance|sp__ 0.000368 0.01918</span>
<span class="co">#&gt; 1|sp__@site      0.095200 0.30854</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;                Value Std.Error  Zscore    Pvalue    </span>
<span class="co">#&gt; (Intercept) -2.72144   0.33341 -8.1625 3.282e-16 ***</span>
<span class="co">#&gt; disturbance  0.78157   0.28673  2.7258  0.006414 ** </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
</pre></div>
<p>The results of the random effects imply that the strongest effect is an overall i.i.d. species effect, followed closely by a disturbance by i.i.d. species effect. This implies that species vary strongly in their occurrence in disturbed or undisturbed sites, that there is a clear community difference between these treatments. the next strongest effect is the nested phylogenetic effect. But how can we know if this effect is strong enough to take seriously? Well one way to get an idea is to run a likelihood ratio test on the random effect. This can be achieved by using the the <code><a href="../reference/pglmm_profile_LRT.html">pglmm_profile_LRT()</a></code> function, at least for binomial models.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">mod</span><span class="op">$</span><span class="kw">ss</span>)
<span class="co">#&gt; [1] "1|sp"             "1|sp__"           "1|site"           "disturbance|sp"  </span>
<span class="co">#&gt; [5] "disturbance|sp__" "1|sp__@site"</span>
<span class="kw">test_nested</span> <span class="op">&lt;-</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm_profile_LRT.html">pglmm_profile_LRT</a></span>(<span class="kw">mod</span>, re.number = <span class="fl">6</span>) <span class="co">## sp__@site is the 6th random effect</span>
<span class="kw">test_nested</span>
<span class="co">#&gt; $LR</span>
<span class="co">#&gt; [1] 4.017913</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $df</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $Pr</span>
<span class="co">#&gt; [1] 0.002293056</span>
</pre></div>
<p>This result suggests that there is overall a nested phylogenetic effect. What does this mean? Well essentially a model where the within site distributions of species are reasonably explained by the phylogenetic covariance of species implies a ‘phylogenetic clustering’ effect, that is that closely related species are more likely to be found together in the same community, relative to the total variance in communities across sites. In the original paper I analysed this data using traditional community phylogenetics methods (null model based) and found that generally the disturbed sites were phylogenetically clustered but undisturbed sites were not. If I split the data this way and model each separately, does this result hold up?</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">mod_disturbed</span> <span class="op">&lt;-</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm.html">pglmm</a></span>(<span class="kw">pres</span> <span class="op">~</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span>) <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span><span class="op">@</span>site) <span class="op">+</span> 
                               (<span class="fl">1</span> <span class="op">|</span> <span class="kw">site</span>), 
                             data = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">data</span> <span class="op">%&gt;%</span>
                               <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">disturbance</span> <span class="op">==</span> <span class="fl">1</span>), 
                             cov_ranef = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(sp = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">phy</span>),
                             family = <span class="st">"binomial"</span>)

<span class="kw">mod_undisturbed</span> <span class="op">&lt;-</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm.html">pglmm</a></span>(<span class="kw">pres</span> <span class="op">~</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span>) <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span><span class="op">@</span>site) <span class="op">+</span> 
                                 (<span class="fl">1</span> <span class="op">|</span> <span class="kw">site</span>), 
                               data = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">data</span> <span class="op">%&gt;%</span>
                                 <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">disturbance</span> <span class="op">==</span> <span class="fl">0</span>), 
                               cov_ranef = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(sp = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">phy</span>),
                               family = <span class="st">"binomial"</span>)
</pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Disturbed phylogenetic clustering test:\n"</span>)
<span class="co">#&gt; Disturbed phylogenetic clustering test:</span>
<span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm_profile_LRT.html">pglmm_profile_LRT</a></span>(<span class="kw">mod_disturbed</span>, re.number = <span class="fl">4</span>)
<span class="co">#&gt; $LR</span>
<span class="co">#&gt; [1] 4.680287</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $df</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $Pr</span>
<span class="co">#&gt; [1] 0.001108513</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Undisturbed phylogenetic clustering test:\n"</span>)
<span class="co">#&gt; Undisturbed phylogenetic clustering test:</span>
<span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm_profile_LRT.html">pglmm_profile_LRT</a></span>(<span class="kw">mod_undisturbed</span>, re.number = <span class="fl">4</span>)
<span class="co">#&gt; $LR</span>
<span class="co">#&gt; [1] -9.778164e-06</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $df</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $Pr</span>
<span class="co">#&gt; [1] 1</span>
</pre></div>
<p>Indeed! My original results hold up to this model-based test of the same question. Whew! (╹◡╹)凸 We can also get an idea of how well the model fits the data by plotting the observed and predicted values of the model side-by-side.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">mod</span>, predicted = <span class="fl">TRUE</span>)
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/plot_mod-1.png" width="90%"></p>
<p>The other result from this model is that there is a strong fixed effect of disturbance. In the context of a binomial multivariate model such as communityPGLMM this means there is an overall increase in the probability of occurrence in disturbed sites. In essence, this means that disturbed sites have a higher species richness at the site level (noting that expected alpha species richness of a site can be expressed as Gamma richness * E(prob_site(occurrence))).</p>
<p>Another way to explore than random effects is to use the Bayesian version of <code>communityPGLMM</code> and then look at the shape of the posterior distribution of our random effect variance terms. Let’s have a look at that.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">mod_bayes</span> <span class="op">&lt;-</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm.html">pglmm</a></span>(<span class="kw">pres</span> <span class="op">~</span> <span class="kw">disturbance</span> <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span>) <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp__</span><span class="op">@</span>site) <span class="op">+</span> 
                           (<span class="fl">1</span> <span class="op">|</span> <span class="kw">site</span>) <span class="op">+</span> (<span class="kw">disturbance</span> <span class="op">|</span> <span class="kw">sp__</span>), 
                         data = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">data</span>, 
                         cov_ranef = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(sp = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">phy</span>),
                         family = <span class="st">"binomial"</span>,
                         bayes = <span class="fl">TRUE</span>,
                         prior = <span class="st">"pc.prior.auto"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">mod_bayes</span>)
<span class="co">#&gt; Generalized linear mixed model for binomial data fit by Bayesian INLA</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:pres ~ disturbance</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; marginal logLik </span>
<span class="co">#&gt;          -619.5 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;                  Variance Std.Dev lower.CI upper.CI</span>
<span class="co">#&gt; 1|sp             2.066571 1.43756 1.097755   4.5151</span>
<span class="co">#&gt; 1|sp__           0.106195 0.32588 0.020672   1.2172</span>
<span class="co">#&gt; 1|site           0.007038 0.08389 0.001174   0.1937</span>
<span class="co">#&gt; disturbance|sp   1.902315 1.37924 0.904636   4.9701</span>
<span class="co">#&gt; disturbance|sp__ 0.036600 0.19131 0.005833   1.1108</span>
<span class="co">#&gt; 1|sp__@site      0.103666 0.32197 0.043608   0.2873</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;                Value lower.CI upper.CI</span>
<span class="co">#&gt; (Intercept) -3.15279 -3.59926  -2.7476</span>
<span class="co">#&gt; disturbance  0.92866  0.44727   1.4299</span>
</pre></div>
<p>“pc.prior.auto” is a good choice of prior I find for binomial models. If you are interested in the details of this kind of prior (known as a penalising complexity prior), check out this paper: <a href="https://arxiv.org/abs/1403.4630" class="uri">https://arxiv.org/abs/1403.4630</a>.</p>
<p>The results of this model are consistent with the ML model, which is good to see. Now we also have lower and upper credible intervals. We can look at the full approximate marginal posterior distributions of the random effects and fixed effects with the <code>plot_bayes</code> function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="../reference/plot_bayes.html">plot_bayes</a></span>(<span class="kw">mod_bayes</span>, sort = <span class="fl">TRUE</span>)
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/plot_bayes-1.png" width="85%"></p>
<p>What we are looking for is that the posterior distribution mode is well away from zero, and that it looks relatively symmetrical. If it is skewed and crammed up against the left side of the plot, near zero, that is a sign the effect is not especially strong (remembering that variance components cannot be less than or equal zero, so you always will see some positive probability mass). The most obvious effects here are again the species random effect, the species by disturbance random effect, and the nested phylogenetic effect. In this plot, the 95% credible interval is also plotted, along with the posterior mean (the point and bar at the bottom of each density). For the random effects these aren’t too meaningful, but they can help distinguish genuine effects in the fixed effects. If these credible intervals overlap zero in the fixed effects, the density will be plotted with a lighter colour to suggest it is not a strong effect (not relevant in this model since both fixed effects are strong).</p>
</div>
<div id="model-assumption-checks" class="section level2">
<h2 class="hasAnchor">
<a href="#model-assumption-checks" class="anchor"></a>Model Assumption Checks</h2>
<p>The next thing we might want to check is whether assumptions of the model are met by the data. The typical way to do this is by plotting and / or analysing the model residuals. In non-Gaussian models such as this one, this can be a little less straightforward. However, <code>phyr</code> output supports the <code>DHARMa</code> package, which can generated a generalised type of residual known as randomized quantile residuals (or sometimes Dunn-Smyth residuals). These can be calculated and inspected for nearly any error distribution. We can produce standard diagnostic plots for our <code>phyr</code> model by simply calling <code><a href="https://rdrr.io/pkg/DHARMa/man/simulateResiduals.html">DHARMa::simulateResiduals</a></code> on the model object.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">resids</span> <span class="op">&lt;-</span> <span class="kw">DHARMa</span>::<span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/simulateResiduals.html">simulateResiduals</a></span>(<span class="kw">mod_bayes</span>, plot = <span class="fl">FALSE</span>)
<span class="co">#&gt; Warning in checkModel(fittedModel): DHARMa: fittedModel not in class of</span>
<span class="co">#&gt; supported models. Absolutely no guarantee that this will work!</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">resids</span>)
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/call_dharma-1.png" width="90%"></p>
<p>So that looks pretty good to me, though some of the tests failed. Specifically the residual quantiles are not quite as flat with respect to the model predictions as we would like them to be. There is a slight curvature, and the residuals are overall increasing slightly with higher predictions. Visually however, this looks like a weak effect, and are only likely a ‘significant’ deviation because of the large number of data-points. I am reasonably comfortable that the model assumptions are satisfied fairly well in this case. Given that we are interested in the effect of disturbance, we may also want to check that the residuals do not show any strong patterns with the disturbance treatment. This is simple to do with <code>DHARMa</code> as follows:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw">DHARMa</span>::<span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/plotResiduals.html">plotResiduals</a></span>(<span class="kw">resids</span>, <span class="kw">mod_bayes</span><span class="op">$</span><span class="kw">data</span><span class="op">$</span><span class="kw">disturbance</span>)
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/some_other_plots-1.png" width="85%"></p>
<p>Obviously no problems there.</p>
</div>
<div id="goodness-of-fit" class="section level2">
<h2 class="hasAnchor">
<a href="#goodness-of-fit" class="anchor"></a>Goodness of Fit</h2>
<p>Another good question about our model is simply: how well does it fit the data. A metric appealing in its simplicity is the classic R<sup>2</sup> metric, which purports to estimate the proportion of the variance in the response explained by the model predictors. Once again though, when using non-Gaussian errors this can become a bit tricky. An additional complication is created by model with random effects. Given that rrandom effects are very flexible model components (for example, nothing stopping you from fitting a random effect for each observation in your dataset), a straight-up calculation of variance explains isn’t too meaningful. That being said, methods that can produce a useful R<sup>2</sup> metric in the complex situation have been developed. The package <code>rr2</code> is able to calculate several flavours of R<sup>2</sup>, and supports <code>phyr</code>’s <code>communityPGLMM</code> model object. Let’s try it!</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw">rr2</span>::<span class="fu"><a href="https://rdrr.io/pkg/rr2/man/R2.html">R2</a></span>(<span class="kw">mod</span>)
<span class="co">#&gt; Models of class pglmm do not have a R2_resid method.</span>
<span class="co">#&gt;    R2_lik   R2_pred </span>
<span class="co">#&gt; 0.1785376 0.4443456</span>
<span class="kw">rr2</span>::<span class="fu"><a href="https://rdrr.io/pkg/rr2/man/R2.html">R2</a></span>(<span class="kw">mod_bayes</span>)
<span class="co">#&gt; Models of class pglmm do not have a R2_resid method.</span>
<span class="co">#&gt; Models of class pglmm with bayes = TRUE do not have a R2_lik method.</span>
<span class="co">#&gt;   R2_pred </span>
<span class="co">#&gt; 0.4586559</span>
</pre></div>
<p>There we go! 0.46 for <code>mod_bayes</code>! We can think of this as saying roughly 46% of our response’s variance has been explained by our model, taking into account the various sources of covariance we modeled, subject to a boatload of assumption and caveats of course. That’s handy! See Ives (2018) for the full description of how this R<sup>2</sup> works.</p>
</div>
<div id="auc-specificity-and-true-skill-statistics-tss" class="section level2">
<h2 class="hasAnchor">
<a href="#auc-specificity-and-true-skill-statistics-tss" class="anchor"></a>AUC, Specificity, and True Skill Statistics (TSS)</h2>
<p>Assessments of predictive accuracy of Species Distribution Models generally are based on confusion matrices that record the numbers of true positive, false positive, true negative, and false negative. Such matrices are straightforward to construct for models providing presence-absence predictions, which is true for most SDMs. Commonly used measures for SDMs include Specificity (true negative rate), Sensitivity (true positive rate), True Skill Statistic (TSS = Sensitivity + Specificity - 1), and area under the receiver operating characteristic (ROC) curve (AUC) (<a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2664.2006.01214.x">Allouche et al. 2006</a>). Combining the observed values with the predictions generated by the <code><a href="../reference/pglmm_predicted_values.html">pglmm_predicted_values()</a></code> function, we can calculate such measures to evaluate the performance of our models.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="kw">pred_mod</span> <span class="op">=</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm_predicted_values.html">pglmm_predicted_values</a></span>(<span class="kw">mod</span>)<span class="op">$</span><span class="kw">Y_hat</span>
<span class="kw">obs_mod</span> <span class="op">=</span> <span class="kw">mod</span><span class="op">$</span><span class="kw">data</span><span class="op">$</span><span class="kw">pres</span>
<span class="kw">roc_mod</span> <span class="op">&lt;-</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span>(<span class="kw">obs_mod</span>, <span class="kw">pred_mod</span>, percent = <span class="kw">T</span>, direction = <span class="st">"&lt;"</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>))
(<span class="kw">AUC</span> <span class="op">=</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/auc.html">auc</a></span>(<span class="kw">roc_mod</span>))
<span class="co">#&gt; Area under the curve: 92.74%</span>
(<span class="kw">roc_mod_2</span> <span class="op">&lt;-</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/coords.html">coords</a></span>(<span class="kw">roc_mod</span>, <span class="st">"best"</span>, ret = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"sens"</span>, <span class="st">"spec"</span>), transpose = <span class="kw">F</span>) <span class="op">/</span> <span class="fl">100</span>)
<span class="co">#&gt;   sensitivity specificity</span>
<span class="co">#&gt; 1   0.8561404   0.8494337</span>
(<span class="kw">TSS</span> <span class="op">=</span> <span class="kw">roc_mod_2</span>[<span class="fl">1</span>, <span class="st">"sensitivity"</span>] <span class="op">+</span> <span class="kw">roc_mod_2</span>[<span class="fl">1</span>, <span class="st">"specificity"</span>] <span class="op">-</span> <span class="fl">1</span>)
<span class="co">#&gt; [1] 0.7055741</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">ROCR</span>::<span class="fu"><a href="https://rdrr.io/pkg/ROCR/man/performance.html">performance</a></span>(<span class="kw">ROCR</span>::<span class="fu"><a href="https://rdrr.io/pkg/ROCR/man/prediction.html">prediction</a></span>(<span class="kw">pred_mod</span>, <span class="kw">obs_mod</span>), measure = <span class="st">"tpr"</span>, 
                        x.measure = <span class="st">"fpr"</span>), main = <span class="st">"ROC Curve"</span>) <span class="co"># ROC curve</span>
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/perfML-1.png" width="672"></p>
<p>We can see that the AUC is pretty high (0.9274238) with the model fitted with maximum likihood framework (<code>mod</code>). True positive rate and true negative rates are also both reasonably high. What about the model fitted with Bayesian framework (<code>mod_bayes</code>)? Not surprising, the results are similar to those of <code>mod</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="kw">pred_mod_bayes</span> <span class="op">=</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm_predicted_values.html">pglmm_predicted_values</a></span>(<span class="kw">mod_bayes</span>)<span class="op">$</span><span class="kw">Y_hat</span>
<span class="kw">obs_mod_bayes</span> <span class="op">=</span> <span class="kw">mod_bayes</span><span class="op">$</span><span class="kw">data</span><span class="op">$</span><span class="kw">pres</span>
<span class="kw">roc_mod_bayes</span> <span class="op">&lt;-</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span>(<span class="kw">obs_mod_bayes</span>, <span class="kw">pred_mod_bayes</span>, percent = <span class="kw">T</span>,
                           direction = <span class="st">"&lt;"</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>))
(<span class="kw">AUC_bayes</span> <span class="op">=</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/auc.html">auc</a></span>(<span class="kw">roc_mod_bayes</span>))
<span class="co">#&gt; Area under the curve: 93.28%</span>
(<span class="kw">roc_mod_bayes2</span> <span class="op">&lt;-</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/coords.html">coords</a></span>(<span class="kw">roc_mod_bayes</span>, <span class="st">"best"</span>, ret = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"sens"</span>, <span class="st">"spec"</span>),
                           transpose = <span class="kw">F</span>) <span class="op">/</span> <span class="fl">100</span>)
<span class="co">#&gt;   sensitivity specificity</span>
<span class="co">#&gt; 1    0.877193   0.8387742</span>
(<span class="kw">TSS_bayes</span> <span class="op">=</span> <span class="kw">roc_mod_bayes2</span>[<span class="fl">1</span>, <span class="st">"sensitivity"</span>] <span class="op">+</span> <span class="kw">roc_mod_bayes2</span>[<span class="fl">1</span>, <span class="st">"specificity"</span>] <span class="op">-</span> <span class="fl">1</span>)
<span class="co">#&gt; [1] 0.7159671</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">ROCR</span>::<span class="fu"><a href="https://rdrr.io/pkg/ROCR/man/performance.html">performance</a></span>(<span class="kw">ROCR</span>::<span class="fu"><a href="https://rdrr.io/pkg/ROCR/man/prediction.html">prediction</a></span>(<span class="kw">pred_mod_bayes</span>, <span class="kw">obs_mod_bayes</span>), measure = <span class="st">"tpr"</span>, 
                        x.measure = <span class="st">"fpr"</span>), main = <span class="st">"ROC Curve"</span>) <span class="co"># ROC curve</span>
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/perfBayes-1.png" width="672"></p>
<p>Now let’s compare the model that does not account for phylogenetic relationships, i.e. the regular joint species distribution models.</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="kw">mod_bayes_no_phy</span> <span class="op">&lt;-</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm.html">pglmm</a></span>(<span class="kw">pres</span> <span class="op">~</span> <span class="kw">disturbance</span> <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">sp</span>) <span class="op">+</span> 
                                  (<span class="fl">1</span> <span class="op">|</span> <span class="kw">site</span>) <span class="op">+</span> (<span class="kw">disturbance</span> <span class="op">|</span> <span class="kw">sp</span>), 
                            data = <span class="kw">oldfield</span><span class="op">$</span><span class="kw">data</span>, 
                            family = <span class="st">"binomial"</span>, bayes = <span class="kw">T</span>,
                            prior = <span class="st">"pc.prior.auto"</span>)

<span class="kw">pred_mod_bayes_no_phy</span> <span class="op">=</span> <span class="kw">phyr</span>::<span class="fu"><a href="../reference/pglmm_predicted_values.html">pglmm_predicted_values</a></span>(<span class="kw">mod_bayes_no_phy</span>)<span class="op">$</span><span class="kw">Y_hat</span>
<span class="kw">obs_mod_bayes_no_phy</span> <span class="op">=</span> <span class="kw">mod_bayes_no_phy</span><span class="op">$</span><span class="kw">data</span><span class="op">$</span><span class="kw">pres</span>
<span class="kw">roc_mod_bayes_no_phy</span> <span class="op">&lt;-</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span>(<span class="kw">obs_mod_bayes_no_phy</span>, <span class="kw">pred_mod_bayes_no_phy</span>,
                                  percent = <span class="kw">T</span>, direction = <span class="st">"&lt;"</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>))
(<span class="kw">AUC_bayes_no_phy</span> <span class="op">=</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/auc.html">auc</a></span>(<span class="kw">roc_mod_bayes_no_phy</span>))
<span class="co">#&gt; Area under the curve: 90.26%</span>
(<span class="kw">roc_mod_bayes_no_phy2</span> <span class="op">&lt;-</span> <span class="kw">pROC</span>::<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/coords.html">coords</a></span>(<span class="kw">roc_mod_bayes_no_phy</span>, <span class="st">"best"</span>, 
                                       ret = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"sens"</span>, <span class="st">"spec"</span>), transpose = <span class="kw">F</span>) <span class="op">/</span> <span class="fl">100</span>)
<span class="co">#&gt;   sensitivity specificity</span>
<span class="co">#&gt; 1   0.8666667   0.8007995</span>
(<span class="kw">TSS_bayes_no_phy</span> <span class="op">=</span> <span class="kw">roc_mod_bayes_no_phy2</span>[<span class="fl">1</span>, <span class="st">"sensitivity"</span>] <span class="op">+</span> 
    <span class="kw">roc_mod_bayes_no_phy2</span>[<span class="fl">1</span>, <span class="st">"specificity"</span>] <span class="op">-</span> <span class="fl">1</span>)
<span class="co">#&gt; [1] 0.6674661</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">ROCR</span>::<span class="fu"><a href="https://rdrr.io/pkg/ROCR/man/performance.html">performance</a></span>(<span class="kw">ROCR</span>::<span class="fu"><a href="https://rdrr.io/pkg/ROCR/man/prediction.html">prediction</a></span>(<span class="kw">pred_mod_bayes_no_phy</span>, <span class="kw">obs_mod_bayes_no_phy</span>), 
                       measure = <span class="st">"tpr"</span>, x.measure = <span class="st">"fpr"</span>), main = <span class="st">"ROC Curve"</span>) <span class="co"># ROC curve</span>
</pre></div>
<p><img src="phyr_example_empirical_files/figure-html/perfBayesNoPhy-1.png" width="672"></p>
<p>Including species’ phylogenetic relationships in the model indeed improved the model performance. After dropping the phylogenetic random terms from the model, <code>AUC</code> decreased from 0.9327863 to 0.9025726 and <code>TSS</code> decreased from 0.7159671 to 0.6674661.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Anthony Ives, Russell Dinnage, Lucas A. Nell, Matthew Helmus, Daijiang Li.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
