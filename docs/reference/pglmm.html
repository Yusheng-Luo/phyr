<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Phylogenetic Generalized Linear Mixed Model for Community Data — pglmm • phyr</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Phylogenetic Generalized Linear Mixed Model for Community Data — pglmm"><meta property="og:description" content="This function performs Generalized Linear Mixed Models for binary, count,
and continuous data, estimating regression coefficients with
approximate standard errors. It is specifically designed for community data
in which species occur within multiple sites (locations).
A Bayesian version of PGLMM uses the package INLA,
which is not available on CRAN yet. If you wish to use this option,
you must first install INLA from https://www.r-inla.org/ by running
install.packages('INLA', repos='https://www.math.ntnu.no/inla/R/stable') in R."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/benchmarks.html">Performance benchmark</a>
    </li>
    <li>
      <a href="../articles/pglmm.html">Usage of pglmm()</a>
    </li>
    <li>
      <a href="../articles/phyr_example_empirical.html">pglmm example with empirical data</a>
    </li>
    <li>
      <a href="../articles/plot-re.html">Plot random terms of communityPGLMM</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/daijiang/phyr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Phylogenetic Generalized Linear Mixed Model for Community Data</h1>
    <small class="dont-index">Source: <a href="https://github.com/daijiang/phyr/blob/HEAD/R/pglmm.R" class="external-link"><code>R/pglmm.R</code></a></small>
    <div class="hidden name"><code>pglmm.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function performs Generalized Linear Mixed Models for binary, count,
and continuous data, estimating regression coefficients with
approximate standard errors. It is specifically designed for community data
in which species occur within multiple sites (locations).
A Bayesian version of PGLMM uses the package <code>INLA</code>,
which is not available on CRAN yet. If you wish to use this option,
you must first install <code>INLA</code> from <a href="https://www.r-inla.org/" class="external-link">https://www.r-inla.org/</a> by running
<code>install.packages('INLA', repos='https://www.math.ntnu.no/inla/R/stable')</code> in R.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">pglmm</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  cov_ranef <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  random.effects <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  REML <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nelder-mead-nlopt"</span>, <span class="st">"bobyqa"</span>, <span class="st">"Nelder-Mead"</span>, <span class="st">"subplex"</span><span class="op">)</span>,</span>
<span>  repulsion <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  add.obs.re <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cpp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  bayes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  s2.init <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  B.init <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  reltol <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">6</span>,</span>
<span>  maxit <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  tol.pql <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">6</span>,</span>
<span>  maxit.pql <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  marginal.summ <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  calc.DIC <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  calc.WAIC <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prior <span class="op">=</span> <span class="st">"inla.default"</span>,</span>
<span>  prior_alpha <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  prior_mu <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  ML.init <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  tree <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  tree_site <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  site <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  bayes_options <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  bayes_nested_matrix_as_list <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">communityPGLMM</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  cov_ranef <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  random.effects <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  REML <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nelder-mead-nlopt"</span>, <span class="st">"bobyqa"</span>, <span class="st">"Nelder-Mead"</span>, <span class="st">"subplex"</span><span class="op">)</span>,</span>
<span>  repulsion <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  add.obs.re <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cpp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  bayes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  s2.init <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  B.init <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  reltol <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">6</span>,</span>
<span>  maxit <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  tol.pql <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">6</span>,</span>
<span>  maxit.pql <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  marginal.summ <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  calc.DIC <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  calc.WAIC <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prior <span class="op">=</span> <span class="st">"inla.default"</span>,</span>
<span>  prior_alpha <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  prior_mu <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  ML.init <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  tree <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  tree_site <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  site <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  bayes_options <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  bayes_nested_matrix_as_list <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>formula</dt>
<dd><p>A two-sided linear formula object describing the
mixed effects of the model.</p>
<p>To specify that a random term should have phylogenetic covariance matrix along
with non-phylogenetic one, add <code>__</code> (two underscores) at the end of the group variable;
e.g., <code>+ (1 | sp__)</code> will construct two random terms,
one with phylogenetic covariance matrix and another with non-phylogenetic (identity) matrix.
In contrast, <code>__</code> in the nested terms (below) will only create a phylogenetic covariance matrix.
Nested random terms have the general form <code>(1|sp__@site__)</code> which represents
phylogenetically related species nested within correlated sites.
This form can be used for bipartite questions. For example, species could be
phylogenetically related pollinators and sites could be phylogenetically related plants, leading to
the random effect <code>(1|insects__@plants__)</code>. If more than one phylogeny is used, remember to add
all to the argument <code>cov_ranef = list(insects = insect_phylo, plants = plant_phylo)</code>. Phylogenetic correlations can
be dropped by removing the <code>__</code> underscores. Thus, the form <code>(1|sp@site__)</code> excludes the phylogenetic
correlations among species, while the form <code>(1|sp__@site)</code> excludes the correlations among sites.</p>
<p>Note that correlated random terms are not allowed. For example,
<code>(x|g)</code> will be the same as <code>(0 + x|g)</code> in the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer</a></code> syntax. However,
<code>(x1 + x2|g)</code> won't work, so instead use  <code>(x1|g) + (x2|g)</code>.</p></dd>


<dt>data</dt>
<dd><p>A <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></code> containing the variables named in formula.</p></dd>


<dt>family</dt>
<dd><p>Either "gaussian" for a Linear Mixed Model, or
"binomial" or "poisson" for Generalized Linear Mixed Models.
"family" should be specified as a character string (i.e., quoted). For binomial and
Poisson data, we use the canonical logit and log link functions, respectively.
Binomial data can be either presence/absence, or a two-column array of 'successes' and 'failures'.
For both binomial  and Poisson data, we add an observation-level
random term by default via <code>add.obs.re = TRUE</code>. If <code>bayes = TRUE</code> there are
two additional families available: "zeroinflated.binomial", and "zeroinflated.poisson",
which add a zero inflation parameter; this parameter gives the probability that the response is
a zero. The rest of the parameters of the model then reflect the "non-zero" part part
of the model. Note that "zeroinflated.binomial" only makes sense for success/failure
response data.</p></dd>


<dt>cov_ranef</dt>
<dd><p>A named list of covariance matrices of random terms. The names should be the
group variables that are used as random terms with specified covariance matrices
(without the two underscores, e.g. <code>list(sp = tree1, site = tree2)</code>). The actual object
can be either a phylogeny with class "phylo" or a prepared covariance matrix. If it is a phylogeny,
<code>pglmm</code> will prune it and then convert it to a covariance matrix assuming Brownian motion evolution.
<code>pglmm</code> will also standardize all covariance matrices to have determinant of one. Group variables
will be converted to factors and all covariance matrices will be rearranged so that rows and
columns are in the same order as the levels of their corresponding group variables.</p></dd>


<dt>random.effects</dt>
<dd><p>Optional pre-build list of random effects. If <code>NULL</code> (the default),
the function <code><a href="prep_dat_pglmm.html">prep_dat_pglmm</a></code> will prepare the random effects for you from the information
in <code>formula</code>, <code>data</code>, and <code>cov_ranef</code>. <code>random.effect</code> allows a list of
pre-generated random effects terms to increase flexibility; for example, this makes it
possible to construct models with both phylogenetic correlation and spatio-temporal autocorrelation.
In preparing <code>random.effect</code>, make sure that the orders of rows and columns of
covariance matrices in the list are the same as their corresponding group variables
in the data. Also, this should be <em>a list of lists</em>, e.g.
<code>random.effects = list(re1 = list(matrix_a), re2 = list(1, sp = sp, covar = Vsp))</code>.</p></dd>


<dt>REML</dt>
<dd><p>Whether REML or ML is used for model fitting the random effects. Ignored if
<code>bayes = TRUE</code>.</p></dd>


<dt>optimizer</dt>
<dd><p>nelder-mead-nlopt (default), bobyqa, Nelder-Mead, or subplex.
Nelder-Mead is from the stats package and the other optimizers are from the nloptr package.
Ignored if <code>bayes = TRUE</code>.</p></dd>


<dt>repulsion</dt>
<dd><p>When there are nested random terms specified, <code>repulsion = FALSE</code> tests
for phylogenetic underdispersion while <code>repulsion = FALSE</code> tests for overdispersion.
This argument is a logical vector of length either 1 or &gt;1.
If its length is 1, then all covariance matrices in nested terms will be either
inverted (overdispersion) or not. If its length is &gt;1, then you can select
which covariance matrix in the nested terms to be inverted. Make sure to get
the length right: for all the terms with <code>@</code>, count the number of "__"
to determine the length of repulsion. For example, <code>sp__@site</code> and <code>sp@site__</code>
will each require one element of <code>repulsion</code>, while <code>sp__@site__</code> will take two
elements (repulsion for sp and repulsion for site). Therefore, if your nested terms are
<code>(1|sp__@site) + (1|sp@site__) + (1|sp__@site__)</code>, then you should set the
repulsion to be something like <code>c(TRUE, FALSE, TRUE, TRUE)</code> (length of 4).</p></dd>


<dt>add.obs.re</dt>
<dd><p>Whether to add an observation-level random term for binomial or Poisson
distributions. Normally it would be a good idea to add this to account for overdispersion,
so <code>add.obs.re = TRUE</code> by default.</p></dd>


<dt>verbose</dt>
<dd><p>If <code>TRUE</code>, the model deviance and running
estimates of <code>s2</code> and <code>B</code> are plotted each iteration
during optimization.</p></dd>


<dt>cpp</dt>
<dd><p>Whether to use C++ function for optim. Default is TRUE. Ignored if <code>bayes = TRUE</code>.</p></dd>


<dt>bayes</dt>
<dd><p>Whether to fit a Bayesian version of the PGLMM using <code>r-inla</code>.</p></dd>


<dt>s2.init</dt>
<dd><p>An array of initial estimates of s2 for each random
effect that scales the variance. If s2.init is not provided for
<code>family="gaussian"</code>, these are estimated using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></code> assuming
no phylogenetic signal. A better approach might be to run <code>link[lme4:lmer]{lmer}</code>
and use the output random effects for <code>s2.init</code>. If <code>s2.init</code> is not
provided for <code>family = "binomial"</code>, these are set to 0.25.</p></dd>


<dt>B.init</dt>
<dd><p>Initial estimates of \(B\), a matrix containing
regression coefficients in the model for the fixed effects. This
matrix must have <code>dim(B.init) = c(p + 1, 1)</code>, where <code>p</code> is the
number of predictor (independent) variables; the first element of
<code>B</code> corresponds to the intercept, and the remaining elements
correspond in order to the predictor (independent) variables in the
formula. If <code>B.init</code> is not provided, these are estimated
using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></code> or <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></code> assuming no phylogenetic signal.
A better approach might be to run <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></code> and use the
output fixed effects for <code>B.init</code>. When <code>bayes = TRUE</code>, initial values are estimated
using the maximum likelihood fit unless <code>ML.init = FALSE</code>, in
which case the default <code>INLA</code> initial values will be used.</p></dd>


<dt>reltol</dt>
<dd><p>A control parameter dictating the relative tolerance
for convergence in the optimization; see <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>.</p></dd>


<dt>maxit</dt>
<dd><p>A control parameter dictating the maximum number of
iterations in the optimization; see <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>.</p></dd>


<dt>tol.pql</dt>
<dd><p>A control parameter dictating the tolerance for
convergence in the PQL estimates of the mean components of the
GLMM. Ignored if <code>family = "gaussian"</code> or <code>bayes = TRUE</code>.</p></dd>


<dt>maxit.pql</dt>
<dd><p>A control parameter dictating the maximum number
of iterations in the PQL estimates of the mean components of the
GLMM. Ignored if <code>family = "gaussian"</code> or <code>bayes = TRUE</code>.</p></dd>


<dt>marginal.summ</dt>
<dd><p>Summary statistic to use for the estimate of coefficients when
doing a Bayesian PGLMM (when <code>bayes = TRUE</code>). Options are: "mean",
"median", or "mode", referring to different characterizations of the central
tendency of the Bayesian posterior marginal distributions. Ignored if <code>bayes = FALSE</code>.</p></dd>


<dt>calc.DIC</dt>
<dd><p>Should the Deviance Information Criterion be calculated and returned
when doing a Bayesian PGLMM? Ignored if <code>bayes = FALSE</code>.</p></dd>


<dt>calc.WAIC</dt>
<dd><p>Should the WAIC be calculated and returned
when doing a Bayesian PGLMM? Ignored if <code>bayes = FALSE</code>.</p></dd>


<dt>prior</dt>
<dd><p>Which type of default prior should be used by <code>pglmm</code>?
Only used if <code>bayes = TRUE</code>. There are currently four options:
"inla.default", which uses the default <code>INLA</code> priors; "pc.prior.auto", which uses a
complexity penalizing prior (as described in
<a href="https://arxiv.org/abs/1403.4630v3" class="external-link">Simpson et al. (2017)</a>) designed to automatically
choose good parameters (only available for gaussian and binomial responses); "pc.prior", which
allows the user to set custom parameters on the "pc.prior" prior, using the <code>prior_alpha</code>
and <code>prior_mu</code> parameters (Run <code>INLA::inla.doc("pc.prec")</code> for details on these
parameters); and "uninformative", which sets a very uninformative prior
(nearly uniform) by using a very flat exponential distribution. The last option is generally
not recommended but may in some cases give estimates closer to the maximum likelihood estimates.
"pc.prior.auto" is only implemented for <code>family = "gaussian"</code> and <code>family = "binomial"</code>
currently.</p></dd>


<dt>prior_alpha</dt>
<dd><p>Only used if <code>bayes = TRUE</code> and <code>prior = "pc.prior"</code>, in
which case it sets the alpha parameter of <code>INLA</code>'s complexity penalizing prior for the
random effects. The prior is an exponential distribution where prob(sd &gt; mu) = alpha,
where sd is the standard deviation of the random effect.</p></dd>


<dt>prior_mu</dt>
<dd><p>Only used if <code>bayes = TRUE</code> and <code>prior = "pc.prior"</code>, in
which case it sets the mu parameter of <code>INLA</code>'s complexity penalizing prior for the
random effects. The prior is an exponential distribution where prob(sd &gt; mu) = alpha,
where sd is the standard deviation of the random effect.</p></dd>


<dt>ML.init</dt>
<dd><p>Only relevant if <code>bayes = TRUE</code>. Should maximum
likelihood estimates be calculated and used as initial values for
the Bayesian model fit? Sometimes this can be helpful, but it may not help; thus,
we set the default to <code>FALSE</code>. Also, it
does not work with the zero-inflated families.</p></dd>


<dt>tree</dt>
<dd><p>A phylogeny for column sp, with "phylo" class, or a covariance matrix for sp.
Make sure to have all species in the matrix; if the matrix is not standardized,
(i.e., det(tree) != 1), <code>pglmm</code> will try to standardize it for you.
No longer used: keep here for compatibility.</p></dd>


<dt>tree_site</dt>
<dd><p>A second phylogeny for "site". This is required only if the
site column contains species instead of sites. This can be used for bipartitie
questions; tree_site can also be a covariance matrix. Make sure to have all sites
in the matrix; if the matrix is not standardized (i.e., det(tree_site) != 1),
pglmm` will try to standardize it for you. No longer used: keep here for compatibility.</p></dd>


<dt>sp</dt>
<dd><p>No longer used: keep here for compatibility.</p></dd>


<dt>site</dt>
<dd><p>No longer used: keep here for compatibility.</p></dd>


<dt>bayes_options</dt>
<dd><p>Additional options to pass to INLA for if <code>bayes = TRUE</code>. A named list where the names
correspond to parameters in the <code>inla</code> function. One special option is <code>diagonal</code>: if an element in
the options list is names <code>diagonal</code> this tells <code>INLA</code> to add its value to the diagonal of the random effects
precision matrices. This can help with numerical stability if the model is ill-conditioned (if you get a lot of warnings,
try setting this to <code>list(diagonal = 1e-4)</code>).</p></dd>


<dt>bayes_nested_matrix_as_list</dt>
<dd><p>For <code>bayes = TRUE</code>, prepare the nested terms as a list of length of 4 as the old way?</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>An object (list) of class <code>communityPGLMM</code> with the following elements:</p>
<dl><dt>formula</dt>
<dd><p>the formula for fixed effects</p></dd>

<dt>formula_original</dt>
<dd><p>the formula for both fixed effects and random effects</p></dd>

<dt>data</dt>
<dd><p>the dataset</p></dd>

<dt>family</dt>
<dd><p><code>gaussian</code>, <code>binomial</code>, or <code>poisson</code> depending on the model fit</p></dd>

<dt>random.effects</dt>
<dd><p>the list of random effects</p></dd>

<dt>B</dt>
<dd><p>estimates of the regression coefficients</p></dd>

<dt>B.se</dt>
<dd><p>approximate standard errors of the fixed effects regression coefficients.
This is set to NULL if <code>bayes = TRUE</code>.</p></dd>

<dt>B.ci</dt>
<dd><p>approximate Bayesian credible interval of the fixed effects regression coefficients.
This is set to NULL if <code>bayes = FALSE</code></p></dd>

<dt>B.cov</dt>
<dd><p>approximate covariance matrix for the fixed effects regression coefficients</p></dd>

<dt>B.zscore</dt>
<dd><p>approximate Z scores for the fixed effects regression coefficients. This is set to NULL if <code>bayes = TRUE</code></p></dd>

<dt>B.pvalue</dt>
<dd><p>approximate tests for the fixed effects regression coefficients being different from zero. This is set to NULL if <code>bayes = TRUE</code></p></dd>

<dt>ss</dt>
<dd><p>standard deviations of the random effects for the covariance matrix \(\sigma^2V\) for each random effect in order. For the linear mixed model, the residual variance is listed last.</p></dd>

<dt>s2r</dt>
<dd><p>random effects variances for non-nested random effects</p></dd>

<dt>s2n</dt>
<dd><p>random effects variances for nested random effects</p></dd>

<dt>s2resid</dt>
<dd><p>for linear mixed models, the residual variance</p></dd>

<dt>s2r.ci</dt>
<dd><p>Bayesian credible interval for random effects variances for non-nested random effects.
This is set to NULL if <code>bayes = FALSE</code></p></dd>

<dt>s2n.ci</dt>
<dd><p>Bayesian credible interval for random effects variances for nested random effects.
This is set to NULL if <code>bayes = FALSE</code></p></dd>

<dt>s2resid.ci</dt>
<dd><p>Bayesian credible interval for linear mixed models, the residual variance.
This is set to NULL if <code>bayes = FALSE</code></p></dd>

<dt>logLik</dt>
<dd><p>for linear mixed models, the log-likelihood for either the restricted likelihood (<code>REML=TRUE</code>) or the overall likelihood (<code>REML=FALSE</code>). This is set to NULL for generalized linear mixed models. If <code>bayes = TRUE</code>, this is the marginal log-likelihood</p></dd>

<dt>AIC</dt>
<dd><p>for linear mixed models, the AIC for either the restricted likelihood (<code>REML = TRUE</code>) or the overall likelihood (<code>REML = FALSE</code>). This is set to NULL for generalised linear mixed models</p></dd>

<dt>BIC</dt>
<dd><p>for linear mixed models, the BIC for either the restricted likelihood (<code>REML = TRUE</code>) or the overall likelihood (<code>REML = FALSE</code>). This is set to NULL for generalised linear mixed models</p></dd>

<dt>DIC</dt>
<dd><p>for Bayesian PGLMM, this is the Deviance Information Criterion metric of model fit. This is set to NULL if <code>bayes = FALSE</code>.</p></dd>

<dt>REML</dt>
<dd><p>whether or not REML is used (<code>TRUE</code> or <code>FALSE</code>).</p></dd>

<dt>bayes</dt>
<dd><p>whether or not a Bayesian model was fit.</p></dd>

<dt>marginal.summ</dt>
<dd><p>The specified summary statistic used to summarize the Bayesian marginal distributions.
Only present if <code>bayes = TRUE</code></p></dd>

<dt>s2.init</dt>
<dd><p>the user-provided initial estimates of <code>s2</code></p></dd>

<dt>B.init</dt>
<dd><p>the user-provided initial estimates of <code>B</code></p></dd>

<dt>Y</dt>
<dd><p>the response (dependent) variable returned in matrix form</p></dd>

<dt>X</dt>
<dd><p>the predictor (independent) variables returned in matrix form (including 1s in the first column)</p></dd>

<dt>H</dt>
<dd><p>the residuals. For linear mixed models, this does not account for random terms,
To get residuals after accounting for both fixed and random terms, use <code><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals()</a></code>.
For the generalized linear mixed model, these are the predicted residuals in the
logit -1 space.</p></dd>

<dt>iV</dt>
<dd><p>the inverse of the covariance matrix for the entire system (of dimension (<code>nsp</code> * <code>nsite</code>)
by (<code>nsp</code> * <code>nsite</code>)). This is NULL if <code>bayes = TRUE</code>.</p></dd>

<dt>mu</dt>
<dd><p>predicted mean values for the generalized linear mixed model (i.e., similar to <code>fitted(merMod)</code>).
Set to NULL for linear mixed models, for which we can use <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code>.</p></dd>

<dt>nested</dt>
<dd><p>matrices used to construct the nested design matrix. This is set to NULL if <code>bayes = TRUE</code></p></dd>

<dt>Zt</dt>
<dd><p>the design matrix for random effects. This is set to NULL if <code>bayes = TRUE</code></p></dd>

<dt>St</dt>
<dd><p>diagonal matrix that maps the random effects variances onto the design matrix</p></dd>

<dt>convcode</dt>
<dd><p>the convergence code provided by <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>. This is set to NULL if <code>bayes = TRUE</code></p></dd>

<dt>niter</dt>
<dd><p>number of iterations performed by <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>. This is set to NULL if <code>bayes = TRUE</code></p></dd>

<dt>inla.model</dt>
<dd><p>Model object fit by underlying <code>inla</code> function. Only returned
if <code>bayes = TRUE</code></p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>For Gaussian data, <code>pglmm</code> analyzes the phylogenetic linear mixed model</p>
<p>$$Y = \beta_0 + \beta_1x + b_0 + b_1x$$
$$b_0 ~ Gaussian(0, \sigma_0^2I_{sp})$$
$$b_1 ~ Gaussian(0, \sigma_0^2V_{sp})$$
$$\eta ~ Gaussian(0,\sigma^2)$$</p>
<p>where \(\beta_0\) and \(\beta_1\) are fixed
effects, and \(V_{sp}\) is a variance-covariance matrix
derived from a phylogeny (typically under the assumption of
Brownian motion evolution). Here, the variation in the mean
(intercept) for each species is given by the random effect
\(b_0\) that is assumed to be independent among
species. Variation in species' responses to predictor variable
\(x\) is given by a random effect \(b_0\) that is
assumed to depend on the phylogenetic relatedness among species
given by \(V_{sp}\); if species are closely related,
their specific responses to \(x\) will be similar. This
particular model would be specified as</p>
<p><code>z &lt;- pglmm(Y ~ X + (1|sp__), data = data, family = "gaussian", cov_ranef = list(sp = phy))</code></p>
<p>Or you can prepare the random terms manually (not recommended for simple models but may be necessary for complex models):</p>
<p><code>re.1 &lt;- list(1, sp = dat$sp, covar = diag(nspp))</code></p>
<p><code>re.2 &lt;- list(dat$X, sp = dat$sp, covar = Vsp)</code></p>
<p><code>z &lt;- pglmm(Y ~ X, data = data, family = "gaussian", random.effects = list(re.1, re.2))</code></p>
<p>The covariance matrix covar is standardized to have its determinant
equal to 1. This in effect standardizes the interpretation of the
scalar \(\sigma^2\). Although mathematically this is
not required, it is a very good idea to standardize the predictor
(independent) variables to have mean 0 and variance 1. This will
make the function more robust and improve the interpretation of the
regression coefficients. For categorical (factor) predictor
variables, you will need to construct 0-1 dummy variables, and
these should not be standardized (for obvious reasons).</p>
<p>For binary generalized linear mixed models (<code>family =
'binomial'</code>), the function estimates parameters for the model of
the form, for example,</p>
<p>$$y = \beta_0 + \beta_1x + b_0 + b_1x$$
$$Y = logit^{-1}(y)$$
$$b_0 ~ Gaussian(0, \sigma_0^2I_{sp})$$
$$b_1 ~ Gaussian(0, \sigma_0^2V_{sp})$$</p>
<p>where \(\beta_0\) and \(\beta_1\) are fixed
effects, and \(V_{sp}\) is a variance-covariance matrix
derived from a phylogeny (typically under the assumption of
Brownian motion evolution).</p>
<p><code>z &lt;- pglmm(Y ~ X + (1|sp__), data = data, family = "binomial", cov_ranef = list(sp = phy))</code></p>
<p>As with the linear mixed model, it is a very good idea to
standardize the predictor (independent) variables to have mean 0
and variance 1. This will make the function more robust and improve
the interpretation of the regression coefficients.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Ives, A. R. and M. R. Helmus. 2011. Generalized linear
mixed models for phylogenetic analyses of community
structure. Ecological Monographs 81:511-525.</p>
<p>Ives A. R. 2018. Mixed and phylogenetic models: a conceptual introduction to correlated data.
https://leanpub.com/correlateddata.</p>
<p>Rafferty, N. E., and A. R. Ives. 2013. Phylogenetic
trait-based analyses of ecological networks. Ecology 94:2321-2333.</p>
<p>Simpson, Daniel, et al. 2017. Penalising model component complexity:
A principled, practical approach to constructing priors.
Statistical science 32(1): 1-28.</p>
<p>Li, D., Ives, A. R., &amp; Waller, D. M. 2017.
Can functional traits account for phylogenetic signal in community composition?
New Phytologist, 214(2), 607-618.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Anthony R. Ives, Daijiang Li, Russell Dinnage</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## Structure of examples:</span></span></span>
<span class="r-in"><span><span class="co"># First, a (brief) description of model types, and how they are specified</span></span></span>
<span class="r-in"><span><span class="co"># - these are *not* to be run 'as-is'; they show how models should be organised</span></span></span>
<span class="r-in"><span><span class="co"># Second, a run-through of how to simulate, and then analyse, data</span></span></span>
<span class="r-in"><span><span class="co"># - these *are* to be run 'as-is'; they show how to format and work with data</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co">#############################################</span></span></span>
<span class="r-in"><span><span class="co">### Brief summary of models and their use ###</span></span></span>
<span class="r-in"><span><span class="co">#############################################</span></span></span>
<span class="r-in"><span><span class="co">## Model structures from Ives &amp; Helmus (2011)</span></span></span>
<span class="r-in"><span><span class="kw">if</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># dat = data set for regression (note: must have a column "sp" and a column "site")</span></span></span>
<span class="r-in"><span>  <span class="co"># phy = phylogeny of class "phylo"</span></span></span>
<span class="r-in"><span>  <span class="co"># repulsion = to test phylogenetic repulsion or not</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span>  <span class="co"># Model 1 (Eq. 1)</span></span></span>
<span class="r-in"><span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">pglmm</span><span class="op">(</span><span class="va">freq</span> <span class="op">~</span> <span class="va">sp</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span></span>
<span class="r-in"><span>             cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy</span><span class="op">)</span>, REML <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, s2.init <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span>  <span class="co"># Model 2 (Eq. 2)</span></span></span>
<span class="r-in"><span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">pglmm</span><span class="op">(</span><span class="va">freq</span> <span class="op">~</span> <span class="va">sp</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">|</span><span class="va">sp__</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span></span>
<span class="r-in"><span>             cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy</span><span class="op">)</span>, REML <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, s2.init <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span>  <span class="co"># Model 3 (Eq. 3)</span></span></span>
<span class="r-in"><span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">pglmm</span><span class="op">(</span><span class="va">freq</span> <span class="op">~</span> <span class="va">sp</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span></span>
<span class="r-in"><span>             cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy</span><span class="op">)</span>, REML <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, s2.init <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span>  <span class="co">## Model structure from Rafferty &amp; Ives (2013) (Eq. 3)</span></span></span>
<span class="r-in"><span>  <span class="co"># dat = data set</span></span></span>
<span class="r-in"><span>  <span class="co"># phyPol = phylogeny for pollinators (pol)</span></span></span>
<span class="r-in"><span>  <span class="co"># phyPlt = phylogeny for plants (plt)</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">pglmm</span><span class="op">(</span><span class="va">freq</span> <span class="op">~</span> <span class="va">pol</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">pol__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">plt__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">pol__</span><span class="op">@</span><span class="va">plt</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>               <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">pol</span><span class="op">@</span><span class="va">plt__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">pol__</span><span class="op">@</span><span class="va">plt__</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span></span>
<span class="r-in"><span>             cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pol <span class="op">=</span> <span class="va">phyPol</span>, plt <span class="op">=</span> <span class="va">phyPlt</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             REML <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, s2.init <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#####################################################</span></span></span>
<span class="r-in"><span><span class="co">### Detailed analysis showing covariance matrices ###</span></span></span>
<span class="r-in"><span><span class="co">#####################################################</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># This is the example from section 4.3 in Ives, A. R. (2018) Mixed </span></span></span>
<span class="r-in"><span><span class="co"># and phylogenetic models: a conceptual introduction to correlated data.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>package 'ape' was built under R version 4.2.2</span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Investigating covariance matrices for different types of model structure</span></span></span>
<span class="r-in"><span><span class="va">nspp</span> <span class="op">&lt;-</span> <span class="fl">6</span></span></span>
<span class="r-in"><span><span class="va">nsite</span> <span class="op">&lt;-</span> <span class="fl">4</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate a phylogeny that has a lot of phylogenetic signal (power = 1.3)</span></span></span>
<span class="r-in"><span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/compute.brlen.html" class="external-link">compute.brlen</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/rtree.html" class="external-link">rtree</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nspp</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"Grafen"</span>, power <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate species means</span></span></span>
<span class="r-in"><span><span class="va">sd.sp</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">mean.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/rTraitCont.html" class="external-link">rTraitCont</a></span><span class="op">(</span><span class="va">phy</span>, model <span class="op">=</span> <span class="st">"BM"</span>, sigma<span class="op">=</span><span class="va">sd.sp</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Replicate values of mean.sp over sites</span></span></span>
<span class="r-in"><span><span class="va">Y.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">mean.sp</span>, times<span class="op">=</span><span class="va">nsite</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate site means</span></span></span>
<span class="r-in"><span><span class="va">sd.site</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">mean.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nsite</span>, sd<span class="op">=</span><span class="va">sd.site</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Replicate values of mean.site over sp</span></span></span>
<span class="r-in"><span><span class="va">Y.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">mean.site</span>, each<span class="op">=</span><span class="va">nspp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute a covariance matrix for phylogenetic attraction</span></span></span>
<span class="r-in"><span><span class="va">sd.attract</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">Vphy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/vcv.phylo.html" class="external-link">vcv</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Standardize the phylogenetic covariance matrix to have determinant = 1. </span></span></span>
<span class="r-in"><span><span class="co"># (For an explanation of this standardization, see subsection 4.3.1 in Ives (2018))</span></span></span>
<span class="r-in"><span><span class="va">Vphy</span> <span class="op">&lt;-</span> <span class="va">Vphy</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="va">Vphy</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">nspp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Construct the overall covariance matrix for phylogenetic attraction. </span></span></span>
<span class="r-in"><span><span class="co"># (For an explanation of Kronecker products, see subsection 4.3.1 in the book)</span></span></span>
<span class="r-in"><span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">kronecker</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">nsite</span>, ncol <span class="op">=</span> <span class="va">nsite</span><span class="op">)</span>, <span class="va">Vphy</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Y.attract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="va">sd.attract</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="va">V</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate residual errors</span></span></span>
<span class="r-in"><span><span class="va">sd.e</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">Y.e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nspp</span><span class="op">*</span><span class="va">nsite</span>, sd <span class="op">=</span> <span class="va">sd.e</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Construct the dataset</span></span></span>
<span class="r-in"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span>, times <span class="op">=</span> <span class="va">nsite</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nsite</span>, each <span class="op">=</span> <span class="va">nspp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate abundance data</span></span></span>
<span class="r-in"><span><span class="va">d</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y.sp</span> <span class="op">+</span> <span class="va">Y.site</span> <span class="op">+</span> <span class="va">Y.attract</span> <span class="op">+</span> <span class="va">Y.e</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Analyze the model</span></span></span>
<span class="r-in"><span><span class="fu">pglmm</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span>, cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> as(&lt;matrix&gt;, "dgTMatrix") is deprecated since Matrix 1.5-0; do as(as(as(., "dMatrix"), "generalMatrix"), "TsparseMatrix") instead</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Linear mixed model fit by restricted maximum likelihood</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call:Y ~ 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x000001ff72f0ee60&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> logLik    AIC    BIC </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -45.13 102.26 102.46 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Random effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              Variance   Std.Dev</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp        2.105e-01 0.4587672</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp__      1.450e-07 0.0003809</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|site      2.580e-06 0.0016062</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp__@site 1.946e+00 1.3950764</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> residual    5.906e-01 0.7685368</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fixed effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 Value Std.Error  Zscore Pvalue</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept) -0.086412  0.664073 -0.1301 0.8965</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Display random effects: the function `pglmm_plot_ranef()` does what </span></span></span>
<span class="r-in"><span><span class="co"># the name implies. You can set `show.image = TRUE` and `show.sim.image = TRUE` </span></span></span>
<span class="r-in"><span><span class="co"># to see the matrices and simulations.</span></span></span>
<span class="r-in"><span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="pglmm-plot-re.html">pglmm_plot_ranef</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span>, </span></span>
<span class="r-in"><span>                    cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy</span><span class="op">)</span>, show.image <span class="op">=</span> <span class="cn">FALSE</span>, </span></span>
<span class="r-in"><span>                    show.sim.image <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#################################################</span></span></span>
<span class="r-in"><span><span class="co">### Example of a bipartite phylogenetic model ###</span></span></span>
<span class="r-in"><span><span class="co">#################################################</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Investigating covariance matrices for different types of model structure</span></span></span>
<span class="r-in"><span><span class="va">nspp</span> <span class="op">&lt;-</span> <span class="fl">20</span></span></span>
<span class="r-in"><span><span class="va">nsite</span> <span class="op">&lt;-</span> <span class="fl">15</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate a phylogeny that has a lot of phylogenetic signal (power = 1.3)</span></span></span>
<span class="r-in"><span><span class="va">phy.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/compute.brlen.html" class="external-link">compute.brlen</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/rtree.html" class="external-link">rtree</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nspp</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"Grafen"</span>, power <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">phy.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/compute.brlen.html" class="external-link">compute.brlen</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/rtree.html" class="external-link">rtree</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nsite</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"Grafen"</span>, power <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate species means</span></span></span>
<span class="r-in"><span><span class="va">mean.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/rTraitCont.html" class="external-link">rTraitCont</a></span><span class="op">(</span><span class="va">phy.sp</span>, model <span class="op">=</span> <span class="st">"BM"</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Replicate values of mean.sp over sites</span></span></span>
<span class="r-in"><span><span class="va">Y.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">mean.sp</span>, times <span class="op">=</span> <span class="va">nsite</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate site means</span></span></span>
<span class="r-in"><span><span class="va">mean.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/rTraitCont.html" class="external-link">rTraitCont</a></span><span class="op">(</span><span class="va">phy.site</span>, model <span class="op">=</span> <span class="st">"BM"</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Replicate values of mean.site over sp</span></span></span>
<span class="r-in"><span><span class="va">Y.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">mean.site</span>, each <span class="op">=</span> <span class="va">nspp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate covariance matrix for phylogenetic attraction among species</span></span></span>
<span class="r-in"><span><span class="va">sd.sp.attract</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">Vphy.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/vcv.phylo.html" class="external-link">vcv</a></span><span class="op">(</span><span class="va">phy.sp</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Vphy.sp</span> <span class="op">&lt;-</span> <span class="va">Vphy.sp</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="va">Vphy.sp</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">nspp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">V.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">kronecker</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">nsite</span>, ncol <span class="op">=</span> <span class="va">nsite</span><span class="op">)</span>, <span class="va">Vphy.sp</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Y.sp.attract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="va">sd.sp.attract</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="va">V.sp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Generate covariance matrix for phylogenetic attraction among sites</span></span></span>
<span class="r-in"><span><span class="va">sd.site.attract</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">Vphy.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/vcv.phylo.html" class="external-link">vcv</a></span><span class="op">(</span><span class="va">phy.site</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Vphy.site</span> <span class="op">&lt;-</span> <span class="va">Vphy.site</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="va">Vphy.site</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">nsite</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">V.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">kronecker</a></span><span class="op">(</span><span class="va">Vphy.site</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">nspp</span>, ncol <span class="op">=</span> <span class="va">nspp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Y.site.attract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="va">sd.site.attract</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="va">V.site</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate covariance matrix for phylogenetic attraction of species:site interaction</span></span></span>
<span class="r-in"><span><span class="va">sd.sp.site.attract</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">V.sp.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">kronecker</a></span><span class="op">(</span><span class="va">Vphy.site</span>, <span class="va">Vphy.sp</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Y.sp.site.attract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="va">sd.sp.site.attract</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="va">V.sp.site</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate residual error</span></span></span>
<span class="r-in"><span><span class="va">sd.e</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span></span>
<span class="r-in"><span><span class="va">Y.e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nspp</span><span class="op">*</span><span class="va">nsite</span>, sd <span class="op">=</span> <span class="va">sd.e</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Construct the dataset</span></span></span>
<span class="r-in"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">phy.sp</span><span class="op">$</span><span class="va">tip.label</span>, times <span class="op">=</span> <span class="va">nsite</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">phy.site</span><span class="op">$</span><span class="va">tip.label</span>, each <span class="op">=</span> <span class="va">nspp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate abundance data</span></span></span>
<span class="r-in"><span><span class="va">d</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y.sp</span> <span class="op">+</span> <span class="va">Y.site</span> <span class="op">+</span> <span class="va">Y.sp.attract</span> <span class="op">+</span> <span class="va">Y.site.attract</span> <span class="op">+</span> <span class="va">Y.sp.site.attract</span> <span class="op">+</span> <span class="va">Y.e</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot random effects covariance matrices and then add phylogenies</span></span></span>
<span class="r-in"><span><span class="co"># Note that, if show.image and show.sim are not specified, pglmm_plot_ranef() shows</span></span></span>
<span class="r-in"><span><span class="co"># the covariance matrices if nspp * nsite &lt; 200 and shows simulations </span></span></span>
<span class="r-in"><span><span class="co"># if nspp * nsite &gt; 100</span></span></span>
<span class="r-in"><span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="pglmm-plot-re.html">pglmm_plot_ranef</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> </span></span>
<span class="r-in"><span>                    <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp</span><span class="op">@</span><span class="va">site__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site__</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                    data<span class="op">=</span><span class="va">d</span>, cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy.sp</span>, site <span class="op">=</span> <span class="va">phy.site</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pglmm-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># This flips the phylogeny to match to covariance matrices</span></span></span>
<span class="r-in"><span><span class="va">rot.phy.site</span> <span class="op">&lt;-</span> <span class="va">phy.site</span></span></span>
<span class="r-in"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="op">(</span><span class="va">nsite</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">nsite</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/summary.phylo.html" class="external-link">Nnode</a></span><span class="op">(</span><span class="va">phy.site</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></span>
<span class="r-in"><span>   <span class="va">rot.phy.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/rotate.html" class="external-link">rotate</a></span><span class="op">(</span><span class="va">rot.phy.site</span>, node <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy.sp</span>, main <span class="op">=</span> <span class="st">"Species"</span>, direction <span class="op">=</span> <span class="st">"upward"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pglmm-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rot.phy.site</span>, main <span class="op">=</span> <span class="st">"Site"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pglmm-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Analyze the simulated data and compute a P-value for the (1|sp__@site__) </span></span></span>
<span class="r-in"><span><span class="co"># random effect using a LRT. It is often better to fit the reduced model before</span></span></span>
<span class="r-in"><span><span class="co"># the full model, because it s numerically easier to fit the reduced model, </span></span></span>
<span class="r-in"><span><span class="co"># and then the parameter estimates from the reduced model can be given to the</span></span></span>
<span class="r-in"><span><span class="co"># full model. In this case, I have used the estimates of the random effects </span></span></span>
<span class="r-in"><span><span class="co"># from the reduce model, mod.r$ss, as the initial estimates for the same </span></span></span>
<span class="r-in"><span><span class="co"># parameters in the full model in the statement s2.init=c(mod.r$ss, 0.01)^2. </span></span></span>
<span class="r-in"><span><span class="co"># The final 0.01 is for the last random effect in the full model, (1|sp__@site__). </span></span></span>
<span class="r-in"><span><span class="co"># Note also that the output of the random effects from communityPGLMM(), mod.r$ss, </span></span></span>
<span class="r-in"><span><span class="co"># are the standard deviations, so they have to be squared for use as initial </span></span></span>
<span class="r-in"><span><span class="co"># values of variances in mod.f.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mod.r</span> <span class="op">&lt;-</span> <span class="fu">pglmm</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp</span><span class="op">@</span><span class="va">site__</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                        data <span class="op">=</span> <span class="va">d</span>, cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy.sp</span>, site <span class="op">=</span> <span class="va">phy.site</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mod.f</span> <span class="op">&lt;-</span> <span class="fu">pglmm</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site__</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp</span><span class="op">@</span><span class="va">site__</span><span class="op">)</span> <span class="op">+</span> </span></span>
<span class="r-in"><span>               <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">sp__</span><span class="op">@</span><span class="va">site__</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span>, </span></span>
<span class="r-in"><span>               cov_ranef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">phy.sp</span>, site <span class="op">=</span> <span class="va">phy.site</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>               s2.init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mod.r</span><span class="op">$</span><span class="va">ss</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mod.f</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Linear mixed model fit by restricted maximum likelihood</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call:Y ~ 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x000001ff72f0ee60&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> logLik    AIC    BIC </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -698.6 1415.1 1438.2 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Random effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                Variance   Std.Dev</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp          1.176e-05 3.429e-03</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp__        3.044e+00 1.745e+00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|site        2.102e-04 1.450e-02</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|site__      1.179e+00 1.086e+00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp__@site   1.954e+00 1.398e+00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp@site__   1.373e+00 1.172e+00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1|sp__@site__ 4.392e-10 2.096e-05</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> residual      1.048e-05 3.237e-03</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fixed effects:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               Value Std.Error Zscore Pvalue</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept) 0.75921   2.77504 0.2736 0.7844</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="va">pvalue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html" class="external-link">pchisq</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">mod.f</span><span class="op">$</span><span class="va">logLik</span> <span class="op">-</span> <span class="va">mod.r</span><span class="op">$</span><span class="va">logLik</span><span class="op">)</span>, df <span class="op">=</span> <span class="fl">1</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">pvalue</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.9998261</span>
<span class="r-in"><span><span class="co"># } </span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Anthony Ives, Russell Dinnage, Lucas A. Nell, Matthew Helmus, Daijiang Li.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

